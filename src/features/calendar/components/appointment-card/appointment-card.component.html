<div
  [class]="
    'appointment-card transition-colors border-l-4 border-r-4 flex flex-col relative ' +
    (compact() ? 'compact p-1 rounded-md' : 'p-3 shadow-sm rounded-r-md') +
    (disableHover() ? '' : '') +
    (isResizing() ? ' resizing' : '') +
    (isDragging() ? ' dragging cursor-grabbing' : '') +
    (isDragging() && dragPreview() && !dragPreview()!.isValidTarget
      ? ' invalid-drag-target'
      : '') +
    (enableDrag() && !enableResize()
      ? ' month-view-appointment cursor-pointer'
      : '') +
    (enableResize() ? ' day-week-view-appointment cursor-grab' : '')
  "
  [style.height.px]="compact() ? null : dynamicHeight || slotHeight()"
  [style.min-height.px]="compact() ? null : slotHeight()"
  [style.borderLeft]="'4px solid ' + (appointment().doctor?.color || '#9ca3af')"
  [style.borderRight]="'4px solid ' + getStatusColorObj().dark"
  [ngStyle]="{
    background: isHovering ? getStatusColorObj().light : '',
    transition: 'background-color 0.15s',
  }"
  (mouseenter)="onMouseEnter()"
  (mouseleave)="onMouseLeave()"
>
  <!-- Central Drag Handle for All Views except past/completed in month view -->
  @if ( enableDrag() && !isDragging() && !(viewType() === 'month' &&
  (isPastAppointment() || appointment().status === 'completed')) ) {
  <span
    class="drag-handle-center"
    style="position: absolute; top: 4px; right: 4px; z-index: 10"
    (mouseenter)="isHovering = true"
    (mouseleave)="isHovering = false"
  >
    <button
      *ngIf="isHovering"
      class="rounded-full shadow flex items-center justify-center"
      (mousedown)="onMouseDown($event)"
      title="Drag to move appointment"
      [ngStyle]="{
        width: '20px',
        height: '20px',
        background: '#f3f4f6',
        border: 'none',
        outline: 'none',
        borderRadius: '4px',
        cursor: isHovering ? 'move' : 'grab',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: 0
      }"
    >
      <span style="font-size: 16px; color: #333; display: block; margin: auto"
        >â ¿</span
      >
    </button>
  </span>
  }

  <!-- Appointment Card Row -->
  <div class="appointment-row flex items-center w-full relative">
    <!-- Doctor color strip -->
    <span
      class="doctor-strip"
      [ngStyle]="{ background: appointment().doctor?.color || '#9ca3af' }"
    ></span>
    <!-- Time and patient name -->
    <span class="time-patient flex-1 flex flex-col items-start">
      <span class="time font-bold text-gray-900 dark:text-white">
        {{ startTime }}
      </span>
      @if (viewType() === 'day') {
      <span
        class="patient-name ml-0 mt-1"
        [title]="appointment().patient?.name || 'Unknown Patient'"
        style="
          max-width: 90px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          display: block;
        "
      >
        {{ appointment().patient?.name || "Unknown Patient" }}
      </span>
      }
    </span>
  </div>

  <!-- Resize Handle (if resize is enabled, show in both compact and non-compact modes) -->
  @if (enableResize()) {
  <div
    [class]="
      'resize-handle absolute bottom-0 left-0 right-0 cursor-ns-resize flex items-center justify-center transition-all duration-200 group ' +
      (compact() ? 'h-2' : 'h-4')
    "
    [class.opacity-100]="isResizing()"
    [class.opacity-20]="!isResizing()"
    [class.hover:opacity-100]="!isResizing()"
    [class.bg-blue-100]="isResizing()"
    [class.hover:bg-blue-50]="!isResizing()"
    (mousedown)="onResizeStart($event)"
    title="Drag to resize appointment"
    style="z-index: 500 !important; pointer-events: auto !important"
  >
    <!-- Resize indicator (smaller for compact mode) -->
    <div
      [class]="
        'bg-blue-500 rounded-full group-hover:bg-blue-600 transition-all duration-200 shadow-sm ' +
        (compact() ? 'w-6 h-0.5' : 'w-10 h-1') +
        (isResizing()
          ? compact()
            ? ' bg-blue-600'
            : ' bg-blue-600 w-12 h-1.5'
          : '')
      "
    ></div>

    <!-- Additional resize dots for better visibility (only in non-compact mode) -->
    @if (!compact()) {
    <div
      class="absolute inset-x-0 bottom-0 flex justify-center space-x-1 pb-0.5"
    >
      <div class="w-1 h-1 bg-blue-400 rounded-full opacity-60"></div>
      <div class="w-1 h-1 bg-blue-400 rounded-full opacity-60"></div>
      <div class="w-1 h-1 bg-blue-400 rounded-full opacity-60"></div>
    </div>
    }

    <!-- Visual feedback during resize -->
    @if (isResizing()) {
    <div
      [class]="
        'absolute left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-2 py-1 rounded shadow-lg z-50 ' +
        (compact() ? 'text-xs -bottom-5' : 'text-xs -bottom-6')
      "
    >
      {{ endTime }}
    </div>
    }
  </div>
  }
</div>

<!-- Floating Drag Preview -->
<app-floating-drag-preview
  [dragData]="floatingDragData()"
></app-floating-drag-preview>
