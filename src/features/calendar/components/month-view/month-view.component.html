<div class="h-full w-full">
  <!-- Calendar Header with Days of Week -->
  <div class="grid grid-cols-7 border-b border-gray-200 dark:border-gray-700">
    @for (day of weekDays; track day) {
    <div
      [class]="
        'px-4 py-3 text-center border-r border-gray-200 dark:border-gray-700 last:border-r-0 ' +
        (isTodaysDayOfWeek(day)
          ? 'bg-blue-100 dark:bg-blue-900/30 border-b-2 border-blue-500 dark:border-blue-400'
          : 'bg-gray-50 dark:bg-gray-800')
      "
    >
      <span
        [class]="
          'text-sm font-medium uppercase tracking-wide ' +
          (isTodaysDayOfWeek(day)
            ? 'text-blue-700 dark:text-blue-300 font-bold'
            : 'text-gray-500 dark:text-gray-400')
        "
      >
        {{ day }}
      </span>
    </div>
    }
  </div>

  <!-- Calendar Grid -->
  <div
    class="grid grid-cols-7 border-r border-gray-200 dark:border-gray-700"
    #monthGrid
  >
    @for (day of monthDays; track day.toISOString()) {
    <div
      [class]="
        'min-h-[160px] border-b border-r border-gray-200 dark:border-gray-700 last:border-r-0 p-3 relative transition-colors ' +
        (isToday(day)
          ? 'today-cell-highlight'
          : isPastDate(day)
          ? 'bg-gray-50/50 dark:bg-gray-800/50'
          : 'bg-white dark:bg-gray-800') +
        ' ' +
        (!isCurrentMonth(day) ? 'bg-gray-50 dark:bg-gray-750' : '') +
        ' ' +
        (isRestrictedForNewAppointments(day)
          ? 'bg-gray-100 dark:bg-gray-700 cursor-not-allowed'
          : 'hover:bg-gray-50 dark:hover:bg-gray-750 cursor-pointer') +
        ' ' +
        (isWeekend(day) && !isPastDate(day) && !isToday(day)
          ? 'bg-gray-50/80 dark:bg-gray-800/80'
          : '') +
        ' ' +
        (isHoliday(day) && !isPastDate(day) && !isWeekend(day) && !isToday(day)
          ? 'bg-red-50/30 dark:bg-red-900/20'
          : '')
      "
      (click)="!isRestrictedForNewAppointments(day) ? onDateClick(day) : null"
      [attr.data-date]="day.toISOString()"
      [id]="'day-' + formatDateForId(day)"
    >
      <!-- Day Number -->
      <div class="flex items-center justify-between mb-2">
        <span
          [class]="
            'text-sm font-medium leading-none ' +
            (isToday(day)
              ? 'super-today-highlight w-8 h-8 rounded-full flex items-center justify-center text-sm'
              : isCurrentMonth(day)
              ? 'text-gray-900 dark:text-white'
              : 'text-gray-400 dark:text-gray-500') +
            ' ' +
            (isWeekend(day) && isCurrentMonth(day)
              ? 'text-gray-600 dark:text-gray-400'
              : '') +
            ' ' +
            (isHoliday(day) && isCurrentMonth(day)
              ? 'text-red-600 dark:text-red-400'
              : '')
          "
        >
          {{ day.getDate() }}
        </span>

        <!-- Holiday indicator -->
        @if (isHoliday(day) && isCurrentMonth(day)) {
        <div class="w-2 h-2 bg-red-400 rounded-full"></div>
        }
      </div>

      <!-- Appointments Container -->
      <div class="space-y-1 overflow-hidden">
        @for (appointment of getVisibleAppointments(day); track appointment.id;
        let i = $index) {
        <div
          class="appointment-item"
          [class.opacity-50]="
            selectedDoctorId() &&
            appointment.doctor?.id?.toString() !== selectedDoctorId()
          "
        >
          <app-appointment-card
            [appointment]="appointment"
            [compact]="true"
            [enableDrag]="
              !isRestrictedForNewAppointments(day) &&
              !isPastAppointment(appointment)
            "
            [enableResize]="false"
            [gridContainer]="monthGrid"
            [viewType]="'month'"
            [monthDays]="monthDays"
            [doctors]="doctors()"
            [disableHover]="
              isRestrictedForNewAppointments(day) ||
              isPastAppointment(appointment)
            "
            (click)="onAppointmentClick(appointment, $event)"
            (dragStart)="onDragStart($event)"
            (dragUpdate)="onDragUpdate($event)"
            (dragComplete)="onDragComplete($event)"
            [class.pointer-events-none]="isRestrictedDay(day)"
            [class.cursor-pointer]="isPastAppointment(appointment)"
          >
          </app-appointment-card>
        </div>
        }

        <!-- Show more indicator -->
        @if (getHiddenAppointmentsCount(day) > 0) {
        <button
          class="w-full text-left text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium py-1 px-2 rounded hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors"
          (click)="onMoreClick(day, $event)"
        >
          +{{ getHiddenAppointmentsCount(day) }} more
        </button>
        }
      </div>

      <!-- Drop zone overlay (only shown during drag) -->
      @if (isDragActive() && !isRestrictedForNewAppointments(day)) {
      <div
        class="absolute inset-0 border-2 border-dashed border-blue-400 bg-blue-50/30 dark:bg-blue-900/20 rounded-lg flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity pointer-events-none"
        [class.opacity-100]="isDragOverDay(day)"
      >
        <span class="text-sm font-medium text-blue-600 dark:text-blue-400">
          Drop here
        </span>
      </div>
      }

      <!-- Restricted day overlay -->
      @if (isRestrictedDay(day)) {
      <div
        class="absolute inset-0 bg-gray-300/20 dark:bg-gray-600/20 rounded-lg flex items-center justify-center"
      >
        <i class="ri-forbid-line text-gray-400 text-lg"></i>
      </div>
      }
    </div>
    }
  </div>
</div>

<!-- Drag and Drop Confirmation Modal -->
@if (showDragDropModal()) {
<app-drag-drop-confirmation
  [confirmationData]="dragDropConfirmation()"
  [isLoading]="isDragDropLoading()"
  (confirm)="onDragDropConfirm()"
  (cancel)="onDragDropCancel()"
></app-drag-drop-confirmation>
}
